{% extends "base.html" %} {% block title %}Dashboard{% endblock %} {% block
content %}
<h2 class="mt-3">Your Expenses</h2>

<!-- Add Expense & Export Buttons -->
<div class="mb-3">
  <a href="{{ url_for('add_expense') }}" class="btn btn-primary btn-sm mb-2"
    >Add New Expense</a
  >
  <a href="{{ url_for('export_csv') }}" class="btn btn-success btn-sm mb-2"
    >Export CSV</a
  >
  <a href="{{ url_for('export_pdf') }}" class="btn btn-danger btn-sm mb-2"
    >Export PDF</a
  >
</div>

<!-- Summary Cards -->
<div class="row mb-4">
  <div class="col-12 col-md-4 mb-3">
    <div class="card text-white bg-primary shadow-sm">
      <div class="card-body text-center">
        <h5 class="card-title">Total Spent</h5>
        <p class="card-text fs-4">â‚¹ {{ total_spent }}</p>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-4 mb-3">
    <div class="card text-white bg-success shadow-sm">
      <div class="card-body text-center">
        <h5 class="card-title">Highest Expense Category</h5>
        <p
          class="card-text fs-4"
          style="color: {{ category_info[highest_category].color if category_info.get(highest_category) else '#fff' }}"
        >
          {% if category_info.get(highest_category) %} {{
          category_info[highest_category].icon }} {{ highest_category }} {% else
          %} {{ highest_category }} {% endif %}
        </p>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-4 mb-3">
    <div class="card text-white bg-warning shadow-sm">
      <div class="card-body text-center">
        <h5 class="card-title">Average Expense</h5>
        <p class="card-text fs-4">â‚¹ {{ average_expense }}</p>
      </div>
    </div>
  </div>
</div>

<!-- Monthly Category Progress Bars -->
<div class="card mb-4 shadow-sm p-3">
  <h5 class="mb-3">Monthly Spending Breakdown</h5>
  {% for cat, amt in category_data|dictsort(by="value", reverse=True) %} {% set
  percent = (amt / total_spent * 100) if total_spent else 0 %}
  <div class="d-flex justify-content-between align-items-center mb-1">
    <span>
      {% if category_info.get(cat.lower()) %} {{ category_info[cat.lower()].icon
      }} {{ cat }} {% else %} ðŸ“¦ {{ cat }} {% endif %}
    </span>
    <span>{{ "%.1f"|format(percent) }}%</span>
  </div>
  <div class="progress mb-3" style="height: 20px">
    <div
      class="progress-bar"
      role="progressbar"
      style="width: {{ percent }}%; background-color: {{ category_info[cat.lower()].color if category_info.get(cat.lower()) else '#6c757d' }}"
    ></div>
  </div>
  {% endfor %}
</div>

<!-- Charts Row -->
<div class="row mb-4">
  <div class="col-12 col-md-6 mb-3">
    <div class="card shadow-sm p-3">
      <h5 class="text-center">Expenses by Category</h5>
      <canvas id="categoryChart"></canvas>
    </div>
  </div>
  <div class="col-12 col-md-6 mb-3">
    <div class="card shadow-sm p-3">
      <h5 class="text-center">Expenses Over Time</h5>
      <canvas id="trendChart"></canvas>
    </div>
  </div>
</div>

<!-- Expense Table -->
<div class="table-responsive">
  <table class="table table-striped shadow-sm">
    <thead class="table-dark">
      <tr>
        <th>Date</th>
        <th>Category</th>
        <th>Description</th>
        <th>Amount (â‚¹)</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for expense in expenses %}
      <tr>
        <td>{{ expense.date.strftime('%Y-%m-%d') }}</td>
        <td>
          {% set cat_lower = expense.category.lower() %} {% if
          category_info.get(cat_lower) %} {{ category_info[cat_lower].icon }} {%
          else %} ðŸ“¦ {% endif %} {{ expense.category }}
        </td>
        <td>{{ expense.description }}</td>
        <td>{{ "%.2f"|format(expense.amount) }}</td>
        <td>
          <form
            action="{{ url_for('delete_expense', expense_id=expense.id) }}"
            method="post"
            style="display: inline"
          >
            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="4" class="text-center">No expenses yet</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const categoryData = {{ category_data|tojson|safe }};
    const trendData = {{ trend_data|tojson|safe }};
    const category_info = {{ category_info|tojson|safe }};

    // Category Pie Chart
   const categoryLabels = Object.keys(categoryData).map(cat => {
      const catLower = cat.toLowerCase();
      return category_info[catLower] ? category_info[catLower].icon + ' ' + cat : cat;
  });

  const categoryColors = Object.keys(categoryData).map(cat => {
      const catLower = cat.toLowerCase();
      return category_info[catLower] ? category_info[catLower].color : '#6c757d';
  });

    new Chart(document.getElementById('categoryChart'), {
        type: 'pie',
        data: {
            labels: categoryLabels,
            datasets: [{
                data: Object.values(categoryData),
                backgroundColor: categoryColors
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } }
        }
    });

    // Trend Line Chart
    new Chart(document.getElementById('trendChart'), {
        type: 'line',
        data: {
            labels: Object.keys(trendData),
            datasets: [{
                label: 'Expenses Over Time (â‚¹)',
                data: Object.values(trendData),
                fill: false,
                borderColor: '#007bff',
                backgroundColor: '#007bff',
                tension: 0.2
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
        }
    });
</script>
{% endblock %}
